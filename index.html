<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>HP BBQ — Cash Register</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<style>
  :root {
    --card-pad: 14px;
    --card-radius: 12px;
    --gap: 14px;
    --font-size: 18px;
    --btn-pad: 12px 14px;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    font-family: Arial, Helvetica, sans-serif;
    margin: 0 auto;
    max-width: 720px;              /* Desktop layout width; keep on mobile */
    min-width: 720px;              /* Force desktop layout even on small phones (horizontal scroll if needed) */
    padding: 20px;
    text-align: center;
    font-size: var(--font-size);
    line-height: 1.35;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;    /* Reduce mobile lag on taps */
  }

  /* Brand heading */
  .brand {
    margin: 6px 0 14px;
    font-weight: bold;
    letter-spacing: 1px;
  }

  /* Grid + Card (shared) — always 2 columns (desktop layout), even on mobile */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--gap);
    align-items: stretch;
  }

  .card {
    border: 1px solid #ddd;
    border-radius: var(--card-radius);
    padding: var(--card-pad);
    text-align: left;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 160px;
    background: #fff;
  }
  .card h3 {
    margin: 0 0 8px;
    font-weight: bold;
    text-align: center;
  }
  .kv { margin: 4px 0; }

  /* Buttons */
  button {
    padding: var(--btn-pad);
    font-size: var(--font-size);
    border-radius: 10px;
    border: 1px solid #ccc;
    background: #f7f7f7;
    cursor: pointer;
    will-change: transform;     /* Small perf hint */
  }
  button:active { transform: translateY(1px); }
  button:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-row {
    display: flex;
    gap: var(--gap);
    justify-content: center;
    flex-wrap: wrap;
  }
  .btn-full { width: 100%; }
  .selected { background: #000; color: #fff; border-color: #000; }

  /* Inputs */
  input[type="date"], select {
    padding: var(--btn-pad);
    font-size: var(--font-size);
    border-radius: 10px;
    border: 1px solid #ccc;
    width: 100%;
    background: #fff;
  }

  /* Quantity rows in Items card */
  .item-row {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    align-items: center;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px dashed #e6e6e6;
  }
  .item-row:last-child { border-bottom: none; }
  .item-name { text-align: left; }
  .price { text-align: center; min-width: 50px; }
  .qty-controls {
    display: grid;
    grid-template-columns: auto 50px auto;
    align-items: center;
    justify-items: center;
    gap: 8px;
  }
  .qty-badge {
    display: inline-block;
    min-width: 44px;
    text-align: center;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
  }

  /* Totals / Comp Color */
  .highlight { color: #c00; font-weight: bold; }

  /* Admin loading */
  #admin-loading { display: none; font-style: italic; margin: 8px 0; }
  #admin-content { display: none; }

  /* Screen toggles */
  #admin-screen { display: none; }

  /* Access Gate (numeric keypad) — always required on load/refresh */
  #gate {
    position: fixed; inset: 0; background: #fff; z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    padding: 24px;
  }
  #gate .panel {
    width: 100%; max-width: 360px;
    border: 1px solid #ddd; border-radius: var(--card-radius);
    padding: 18px; text-align: center; background: #fff;
  }
  .code-dots { display: flex; justify-content: center; gap: 10px; margin: 10px 0 14px; }
  .dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #999; background: transparent; }
  .dot.filled { background: #000; border-color: #000; }
  .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .keypad button { padding: 16px 0; font-size: 20px; border-radius: 10px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
  .key-wide { grid-column: span 2; }
  #gate .err { color: #c00; min-height: 1.3em; margin-top: 10px; }

  /* Toast (non-blocking messages to reduce mobile lag) */
  #toast {
    position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%);
    background: rgba(0,0,0,0.9); color: #fff; padding: 10px 14px; border-radius: 8px;
    display: none; z-index: 9998;
  }
</style>
</head>
<body>

<!-- ===== ACCESS GATE (keypad; code 5253; REQUIRED every load/refresh) ===== -->
<div id="gate" aria-modal="true" role="dialog">
  <div class="panel" aria-label="Enter Access Code">
    <h3>Enter Access Code</h3>
    <div class="code-dots" aria-hidden="true">
      <div class="dot" id="dot0"></div>
      <div class="dot" id="dot1"></div>
      <div class="dot" id="dot2"></div>
      <div class="dot" id="dot3"></div>
    </div>
    <div class="keypad">
      <button onclick="pressKey('1')">1</button>
      <button onclick="pressKey('2')">2</button>
      <button onclick="pressKey('3')">3</button>
      <button onclick="pressKey('4')">4</button>
      <button onclick="pressKey('5')">5</button>
      <button onclick="pressKey('6')">6</button>
      <button onclick="pressKey('7')">7</button>
      <button onclick="pressKey('8')">8</button>
      <button onclick="pressKey('9')">9</button>
      <button onclick="clearCode()" class="key-wide">Clear</button>
      <button onclick="pressKey('0')">0</button>
      <button onclick="backspace()">⌫</button>
      <button onclick="unlock()" class="key-wide">Enter</button>
    </div>
    <div class="err" id="gateErr" aria-live="polite"></div>
  </div>
</div>

<!-- Non-blocking toast -->
<div id="toast"></div>

<!-- ===== MAIN (POS) ===== -->
<div id="main-screen">
  <div class="brand">HP BBQ</div>

  <div class="grid" style="margin-bottom: var(--gap)">
    <!-- Items -->
    <div class="card">
      <h3>Items</h3>
      <div class="item-row" aria-label="Burger">
        <div class="item-name">Burger</div>
        <div class="price">$7</div>
        <div class="qty-controls">
          <button onclick="changeQty('burger',1)" aria-label="Add Burger">+</button>
          <span id="burgerQty" class="qty-badge" aria-live="polite">0</span>
          <button onclick="changeQty('burger',-1)" aria-label="Remove Burger">-</button>
        </div>
      </div>
      <div class="item-row" aria-label="Hot Dog">
        <div class="item-name">Hot Dog</div>
        <div class="price">$5</div>
        <div class="qty-controls">
          <button onclick="changeQty('hotdog',1)" aria-label="Add Hot Dog">+</button>
          <span id="hotdogQty" class="qty-badge" aria-live="polite">0</span>
          <button onclick="changeQty('hotdog',-1)" aria-label="Remove Hot Dog">-</button>
        </div>
      </div>
    </div>

    <!-- Payment -->
    <div class="card">
      <h3>Payment</h3>
      <div class="btn-row" style="margin-top: 6px;">
        <button id="cashBtn" class="btn-full" onclick="selectPayment('cash')">Cash</button>
        <button id="cardBtn" class="btn-full" onclick="selectPayment('card')">Card</button>
      </div>
      <div class="kv" style="text-align:center;margin-top:8px">
        Total: $<span id="total">0</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <h3>Actions</h3>
      <!-- Comp above Submit (per your layout) -->
      <div class="btn-row" style="margin-top: 6px;">
        <button class="btn-full" onclick="toggleComp()">Comp Order</button>
      </div>
      <div class="btn-row" style="margin-top: 8px;">
        <button id="submitBtn" class="btn-full" onclick="submitOrder(event)">Submit Order</button>
      </div>
      <div class="btn-row" style="margin-top: 8px;">
        <button class="btn-full" onclick="showAdmin()">Admin Panel</button>
      </div>
      <div class="kv" style="text-align:center;margin-top:8px">
        <span id="compHint" aria-live="polite"></span>
      </div>
    </div>

    <!-- Order Date -->
    <div class="card">
      <h3>Order Date</h3>
      <div class="kv">
        <input type="date" id="orderDate" />
      </div>
      <div class="kv" style="text-align:center; opacity:0.8;">
        Defaults to today. Orders save with this date.
      </div>
    </div>
  </div>
</div>

<!-- ===== ADMIN ===== -->
<div id="admin-screen">
  <div class="card" style="text-align:center; margin-bottom: var(--gap);">
    <div class="kv">
      <label for="dateSelect"><strong>Date:</strong></label>
      <select id="dateSelect" onchange="loadStats()"></select>
    </div>
    <div id="totalBlock" class="kv" style="margin-top:8px;"></div>
  </div>

  <div id="admin-loading" aria-live="polite">Loading admin data…</div>

  <div id="admin-content">
    <div class="grid">
      <div class="card">
        <h3>Hot Dogs</h3>
        <div class="kv" id="hdMoney"></div>
        <div class="kv" id="hdItems"></div>
      </div>
      <div class="card">
        <h3>Cash</h3>
        <div class="kv" id="cashMoney"></div>
        <div class="kv" id="cashItems"></div>
      </div>
      <div class="card">
        <h3>Burger</h3>
        <div class="kv" id="bgMoney"></div>
        <div class="kv" id="bgItems"></div>
      </div>
      <div class="card">
        <h3>Card</h3>
        <div class="kv" id="cardMoney"></div>
        <div class="kv" id="cardItems"></div>
      </div>
    </div>

    <div class="btn-row" style="margin-top: var(--gap);">
      <button class="btn-full" onclick="showMain()">Back to Home</button>
    </div>
  </div>
</div>

<script>
/* ==== CONFIG ==== */
const API_URL = "https://script.google.com/macros/s/AKfycbwb_KZrwBErcWTsvnERHS33q0xXggrP1ymF_uxkH0dHiyxoY_nwZv2H4RsHcJfQAcY3/exec";
const ACCESS_CODE = "5253";
const prices = { burger: 7, hotdog: 5 };

/* ==== TOAST (reduce alert usage to avoid mobile jank) ==== */
let toastTimer = null;
function showToast(msg, ms=1500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ t.style.display='none'; }, ms);
}

/* ==== ACCESS GATE (always show on load/refresh) ==== */
let gateBuffer = "";
function updateDots() {
  for (let i = 0; i < 4; i++) {
    const d = document.getElementById("dot"+i);
    if (d) d.classList.toggle("filled", i < gateBuffer.length);
  }
}
function pressKey(digit) {
  if (gateBuffer.length >= 4) return;
  gateBuffer += digit;
  updateDots();
  document.getElementById("gateErr").textContent = "";
  if (gateBuffer.length === 4) unlock(); // auto-enter
}
function backspace() {
  if (!gateBuffer) return;
  gateBuffer = gateBuffer.slice(0, -1);
  updateDots();
}
function clearCode() {
  gateBuffer = "";
  updateDots();
  document.getElementById("gateErr").textContent = "";
}
function unlock() {
  if (gateBuffer === ACCESS_CODE) {
    document.getElementById("gate").style.display = "none";
    const od = document.getElementById("orderDate");
    if (od && !od.value) od.value = todayStr();
  } else {
    document.getElementById("gateErr").textContent = "Invalid code.";
    clearCode();
  }
}
window.addEventListener("keydown", (e) => {
  if (document.getElementById("gate").style.display !== "none") {
    if (e.key >= "0" && e.key <= "9") { pressKey(e.key); }
    else if (e.key === "Backspace") { backspace(); }
    else if (e.key.toLowerCase() === "c") { clearCode(); }
    else if (e.key === "Enter") { unlock(); }
  }
});
window.addEventListener("load", () => {
  // Gate is visible by default; set date default
  const od = document.getElementById("orderDate");
  if (od && !od.value) od.value = todayStr();
  updateDots();
});

/* ==== STATE ==== */
let qty = { burger: 0, hotdog: 0 };
let compOrder = false;
let selectedPayment = null;
let allSales = [];

/* ==== UTIL ==== */
function todayStr(d = new Date()) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`; // YYYY-MM-DD
}

/* ==== POS LOGIC ==== */
function changeQty(item, delta) {
  qty[item] = Math.max(0, qty[item] + delta);
  renderPOS();
}
function toggleComp() {
  compOrder = !compOrder;
  renderPOS();
}
function selectPayment(type) {
  if (selectedPayment === type) { // allow deselect to reduce mistakes
    selectedPayment = null;
    document.getElementById("cashBtn").classList.remove("selected");
    document.getElementById("cardBtn").classList.remove("selected");
  } else {
    selectedPayment = type;
    document.getElementById("cashBtn").classList.toggle("selected", type === "cash");
    document.getElementById("cardBtn").classList.toggle("selected", type === "card");
  }
}

/* Render Main UI */
function renderPOS() {
  document.getElementById("burgerQty").textContent = qty.burger;
  document.getElementById("hotdogQty").textContent = qty.hotdog;

  let total = qty.burger * prices.burger + qty.hotdog * prices.hotdog;
  const totalEl = document.getElementById("total");
  if (compOrder) total = 0;
  totalEl.textContent = total;
  totalEl.className = compOrder ? "highlight" : "";

  const compHint = document.getElementById("compHint");
  compHint.textContent = compOrder ? "Comp active: total is $0 (items still counted as sold)" : "";
}

/* Submit with loading state (non-blocking toast instead of alert) */
async function submitOrder(e) {
  const btn = document.getElementById("submitBtn");
  const od = document.getElementById("orderDate");
  const selectedDate = (od && od.value) ? od.value : todayStr();

  if (qty.burger === 0 && qty.hotdog === 0) { showToast("No items selected"); return; }
  if (!selectedPayment) { showToast("Select a payment method"); return; }

  btn.textContent = "Loading…";
  btn.disabled = true;

  try {
    await fetch(API_URL, {
      method: "POST",
      cache: "no-store",
      body: JSON.stringify({
        date: selectedDate,
        burger: qty.burger,
        hotdog: qty.hotdog,
        comp: compOrder,
        payment: selectedPayment
      })
    });
    // reset state
    qty = { burger: 0, hotdog: 0 };
    compOrder = false;
    selectedPayment = null;
    document.getElementById("cashBtn").classList.remove("selected");
    document.getElementById("cardBtn").classList.remove("selected");
    renderPOS();
    showToast("Order submitted");
  } catch (err) {
    showToast("Error submitting order");
  } finally {
    btn.textContent = "Submit Order";
    btn.disabled = false;
  }
}

/* ==== ADMIN LOGIC ==== */
async function showAdmin() {
  // Switch screens
  document.getElementById("main-screen").style.display = "none";
  document.getElementById("admin-screen").style.display = "block";

  const loadingEl = document.getElementById("admin-loading");
  const contentEl = document.getElementById("admin-content");
  const dateSelect = document.getElementById("dateSelect");
  loadingEl.style.display = "block";
  contentEl.style.display = "none";
  dateSelect.disabled = true;
  dateSelect.innerHTML = "";

  try {
    const res = await fetch(API_URL, { cache: "no-store" });
    allSales = await res.json();

    const dates = [...new Set(allSales.map(r => r.date))].filter(Boolean);
    if (dates.length === 0) {
      // No rows in sheet — show message instead of blank UI
      loadingEl.style.display = "none";
      contentEl.style.display = "block";
      dateSelect.innerHTML = "";
      document.getElementById("totalBlock").innerHTML =
        "<strong>Total</strong><br>No data available yet.";
      // Clear the four cards
      setAdminCardsEmpty();
      return;
    }

    // Populate select with neat M/D/YYYY labels
    dates.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      const [y, m, day] = d.split("-");
      opt.textContent = `${parseInt(m)}/${parseInt(day)}/${y}`;
      dateSelect.appendChild(opt);
    });

    loadStats();                 // load first date by default
    contentEl.style.display = "block";
  } catch (e) {
    showToast("Error loading admin data");
  } finally {
    loadingEl.style.display = "none";
    dateSelect.disabled = false;
  }
}

function setAdminCardsEmpty() {
  document.getElementById("hdMoney").textContent   = `Money: $0`;
  document.getElementById("hdItems").textContent   = `Items: 0`;
  document.getElementById("bgMoney").textContent   = `Money: $0`;
  document.getElementById("bgItems").textContent   = `Items: 0`;
  document.getElementById("cashMoney").textContent = `Money: $0`;
  document.getElementById("cashItems").textContent = `Items: 0`;
  document.getElementById("cardMoney").textContent = `Money: $0`;
  document.getElementById("cardItems").textContent = `Items: 0`;
}

function loadStats() {
  const date = document.getElementById("dateSelect").value;
  const data = allSales.filter(r => r.date === date);

  if (data.length === 0) {
    // Date exists but no rows for that day
    document.getElementById("totalBlock").innerHTML =
      "<strong>Total</strong><br>No data for selected date.";
    setAdminCardsEmpty();
    return;
  }

  const stats = {
    totalMoney: 0, totalItems: 0,
    burgerMoney: 0, burgerItems: 0,
    hotdogMoney: 0, hotdogItems: 0,
    cashMoney: 0, cashItems: 0,
    cardMoney: 0, cardItems: 0
  };

  for (const o of data) {
    const isComp = (o.comp === true || o.comp === "true");
    const b = Number(o.burger) || 0;
    const h = Number(o.hotdog) || 0;
    const orderTotal = isComp ? 0 : (b*prices.burger + h*prices.hotdog);

    stats.totalMoney += orderTotal;
    stats.totalItems += b + h;

    stats.burgerMoney += isComp ? 0 : b*prices.burger;
    stats.burgerItems += b;

    stats.hotdogMoney += isComp ? 0 : h*prices.hotdog;
    stats.hotdogItems += h;

    if (o.payment === "cash") {
      stats.cashMoney += orderTotal;
      stats.cashItems += b + h;
    } else if (o.payment === "card") {
      stats.cardMoney += orderTotal;
      stats.cardItems += b + h;
    }
  }

  document.getElementById("totalBlock").innerHTML =
    `<strong>Total</strong><br>Money: $${stats.totalMoney} &nbsp;|&nbsp; Items: ${stats.totalItems}`;

  document.getElementById("hdMoney").textContent   = `Money: $${stats.hotdogMoney}`;
  document.getElementById("hdItems").textContent   = `Items: ${stats.hotdogItems}`;
  document.getElementById("bgMoney").textContent   = `Money: $${stats.burgerMoney}`;
  document.getElementById("bgItems").textContent   = `Items: ${stats.burgerItems}`;
  document.getElementById("cashMoney").textContent = `Money: $${stats.cashMoney}`;
  document.getElementById("cashItems").textContent = `Items: ${stats.cashItems}`;
  document.getElementById("cardMoney").textContent = `Money: $${stats.cardMoney}`;
  document.getElementById("cardItems").textContent = `Items: ${stats.cardItems}`;
}

/* Screen switch */
function showMain() {
  document.getElementById("admin-screen").style.display = "none";
  document.getElementById("main-screen").style.display = "block";
}

/* init */
renderPOS();
</script>
</body>
</html>
