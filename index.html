<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>HP BBQ — Cash Register</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<style>
  :root{
    --bg:#ffffff;
    --text:#000000;
    --accent:#000000;
    --muted:#f6f6f6;
    --border:#000000;
    --border2:#222222;
    --line:#000000;
    --danger:#c00000;
    --ok:#0a8f08;
    --warn:#d97900;
    --shadow:0 10px 20px rgba(0,0,0,0.18);
    --pad:14px;
    --radius:0px; /* sharp edges */
    --font:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0 auto;
    max-width:720px; min-width:720px;
    background:var(--bg); color:var(--text);
    font-family:Arial, Helvetica, sans-serif;
    font-size:var(--font); line-height:1.35;
    padding:20px; text-align:center;
    -webkit-tap-highlight-color:transparent;
    touch-action:manipulation;
  }
  h1,h2,h3{margin:0 0 10px 0; font-weight:800; letter-spacing:.3px}
  h1{font-size:26px}
  h2{font-size:22px}
  h3{font-size:20px}

  /* Cards */
  .card{
    border:2px solid var(--border);
    border-radius:var(--radius);
    padding:var(--pad);
    background:#fff;
    text-align:left;
    box-shadow:none;
    margin-bottom:14px;
  }
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  .kv{margin:4px 0}
  .line{height:2px; background:var(--line); opacity:.12; margin:8px 0}

  /* Buttons */
  button{
    padding:12px 14px; font-size:var(--font);
    border:2px solid var(--border); background:#fff; color:#000;
    border-radius:var(--radius); cursor:pointer;
  }
  button:hover{filter:brightness(.98)}
  button:active{transform:translateY(1px)}
  .btn-row{display:flex; gap:14px; flex-wrap:wrap; justify-content:center}
  .btn-full{width:100%}
  .selected{background:#000; color:#fff; border-color:#000}

  /* Inputs */
  input[type="date"], select, input[type="text"], input[type="number"]{
    width:100%; padding:12px 14px; font-size:var(--font);
    border:2px solid var(--border); border-radius:var(--radius);
    background:#fff;
  }

  /* Menu rows */
  .item-row{
    display:grid; grid-template-columns:1fr auto auto auto;
    align-items:center; gap:10px; padding:6px 0;
    border-bottom:2px solid var(--border2);
  }
  .item-row:last-child{border-bottom:none}
  .price{text-align:center; min-width:50px}
  .qty-controls{display:grid; grid-template-columns:auto 60px auto; gap:8px; align-items:center; justify-items:center}
  .qty-badge{
    display:inline-block; min-width:56px; text-align:center; padding:6px 8px;
    border:2px solid var(--border); background:#fff; border-radius:var(--radius);
    font-variant-numeric:tabular-nums;
  }

  /* Color cues */
  .highlight{color:var(--danger); font-weight:800}

  /* Screens */
  #admin-screen,#orders-screen,#sheet-modal{display:none}

  /* Loading Overlay */
  #overlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.55);
    display:none; align-items:center; justify-content:center; z-index:9998;
  }
  .overlay-card{
    background:#fff; color:#000; border:3px solid #000; border-radius:0;
    padding:24px 28px; text-align:center; box-shadow:var(--shadow);
    min-width:280px;
  }
  .overlay-card h2{font-size:28px; margin-bottom:8px}

  /* Orders */
  .orders-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
  .orders-grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  .ticket{border:2px solid #000; background:#fff; border-radius:0; padding:14px; text-align:left}
  .ticket-head{display:flex; justify-content:space-between; border-bottom:2px solid #222; padding-bottom:6px; margin-bottom:6px}
  .ticket-items{white-space:pre-line}
  .ticket-footer{display:flex; justify-content:space-between; border-top:2px solid #222; padding-top:6px; margin-top:6px}
  .timer{font-weight:800}
  .timer.green{color:var(--ok)}
  .timer.orange{color:var(--warn)}
  .timer.red{color:var(--danger)}
  .done-btn{background:#000; color:#fff; border-color:#000}

  /* Undo snackbar */
  #undoBar{
    position:fixed; right:20px; bottom:20px; z-index:9997; display:none;
    min-width:280px; background:#111; color:#fff; border:2px solid #000; border-radius:0;
    box-shadow:var(--shadow);
  }
  #undoBar .content{padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px}
  #undoBar button{background:#fff; color:#000; border:2px solid #000}
  #undoProgress{height:6px; background:#4caf50; width:100%; transition:width linear}

  /* Admin grid viewer */
  #sheet-modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; background:rgba(0,0,0,0.55)}
  .sheet-window{
    background:#fff; border:3px solid #000; border-radius:0; width:90%; max-width:900px; max-height:80vh; display:flex; flex-direction:column;
  }
  .sheet-head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:3px solid #000}
  .sheet-title{font-weight:800; font-size:20px}
  .sheet-actions{display:flex; gap:10px}
  .sheet-body{overflow:auto}
  table.sheet{
    width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums;
  }
  table.sheet th, table.sheet td{
    border:2px solid #000; padding:8px 10px; text-align:center;
  }
  table.sheet th{background:#f1f1f1; position:sticky; top:0; z-index:1; font-weight:800}
  td[contenteditable="true"]{background:#fff}
  .row-controls{display:flex; gap:6px; justify-content:center}
  .link-btn{display:inline-block; padding:10px 12px; border:2px solid #000; background:#fff; color:#000; text-decoration:none; border-radius:0}
  .brand{margin:2px 0 14px; font-weight:800; font-size:26px; letter-spacing:.3px}
</style>
</head>
<body>

<!-- Overlay -->
<div id="overlay"><div class="overlay-card"><h2>Loading…</h2><div>Please wait</div></div></div>

<!-- ===== MAIN ===== -->
<div id="main-screen">
  <div class="brand">HP BBQ</div>

  <div class="grid">
    <!-- Menu -->
    <div class="card">
      <h2>Menu</h2>
      <div class="item-row">
        <div class="item-name">Burger</div>
        <div class="price">$7</div>
        <div class="qty-controls">
          <button onclick="changeQty('burger',1)">+</button>
          <span id="burgerQty" class="qty-badge">0</span>
          <button onclick="changeQty('burger',-1)">-</button>
        </div>
      </div>
      <div class="item-row">
        <div class="item-name">Hot Dog</div>
        <div class="price">$5</div>
        <div class="qty-controls">
          <button onclick="changeQty('hotdog',1)">+</button>
          <span id="hotdogQty" class="qty-badge">0</span>
          <button onclick="changeQty('hotdog',-1)">-</button>
        </div>
      </div>
      <div class="item-row">
        <div class="item-name">Soda</div>
        <div class="price">$1</div>
        <div class="qty-controls">
          <button onclick="changeQty('soda',1)">+</button>
          <span id="sodaQty" class="qty-badge">0</span>
          <button onclick="changeQty('soda',-1)">-</button>
        </div>
      </div>
      <div class="line"></div>
      <div class="kv" style="text-align:center;"><strong>Total:</strong> $<span id="total">0</span></div>
    </div>

    <!-- Payment (with Comp) -->
    <div class="card">
      <h2>Payment</h2>
      <div class="btn-row">
        <button id="cashBtn" class="btn-full" onclick="selectPayment('cash')">Cash</button>
        <button id="cardBtn" class="btn-full" onclick="selectPayment('card')">Card</button>
      </div>
      <div class="line"></div>
      <div class="btn-row">
        <button class="btn-full" onclick="toggleComp()">Comp Order</button>
      </div>
      <div class="kv" style="text-align:center; margin-top:6px">
        <span id="compHint"></span>
      </div>
    </div>
  </div>

  <!-- Order Date (kept) -->
  <div class="card">
    <h2>Order Date</h2>
    <input type="date" id="orderDate" />
    <div class="kv" style="text-align:center; opacity:.8;">Defaults to today. Orders save with this date.</div>
  </div>

  <!-- Actions -->
  <div class="card">
    <h2>Actions</h2>
    <div class="btn-row">
      <button id="submitBtn" class="btn-full" onclick="submitOrder()">Submit Order</button>
    </div>
    <div class="btn-row" style="margin-top:10px">
      <button class="btn-full" onclick="showOrders()">Orders</button>
      <button class="btn-full" onclick="showAdmin()">Admin Panel</button>
    </div>
  </div>
</div>

<!-- ===== ORDERS ===== -->
<div id="orders-screen">
  <div class="orders-header">
    <h1>Open Orders</h1>
    <div class="btn-row"><button onclick="showMain()">Back to Home</button></div>
  </div>
  <div id="orders-empty" class="kv" style="text-align:center; display:none;">No open orders.</div>
  <div id="orders-grid" class="orders-grid"></div>
</div>

<!-- ===== ADMIN ===== -->
<div id="admin-screen">
  <div class="card" style="text-align:center;">
    <h1>Admin Panel</h1>
    <div class="btn-row" style="margin:8px 0 14px">
      <a class="link-btn" href="https://drive.google.com/drive/folders/1eZPlupv0k_2W8foDiN2PhuQwjjIoMJz6?usp=sharing" target="_blank">Files (Drive Folder)</a>
      <button onclick="openSheetModal()">View Sheet (Editable)</button>
    </div>
    <div class="kv">
      <label for="dateSelect"><strong>Date:</strong></label>
      <select id="dateSelect" onchange="loadStats()"></select>
    </div>
    <div id="totalBlock" class="kv" style="margin-top:8px;"></div>
  </div>

  <div id="admin-loading" class="kv" style="display:none; font-weight:800;">Loading…</div>

  <div id="admin-content">
    <div class="grid">
      <div class="card"><h3>Hot Dogs</h3><div id="hdMoney"></div><div id="hdItems"></div></div>
      <div class="card"><h3>Cash</h3><div id="cashMoney"></div><div id="cashItems"></div></div>
      <div class="card"><h3>Burger</h3><div id="bgMoney"></div><div id="bgItems"></div></div>
      <div class="card"><h3>Card</h3><div id="cardMoney"></div><div id="cardItems"></div></div>
      <div class="card"><h3>Soda</h3><div id="sdMoney"></div><div id="sdItems"></div></div>
    </div>

    <div class="btn-row" style="margin-top:14px">
      <button class="btn-full" onclick="showMain()">Back to Home</button>
    </div>
  </div>
</div>

<!-- ===== Sheet Modal (Editable Grid) ===== -->
<div id="sheet-modal">
  <div class="sheet-window">
    <div class="sheet-head">
      <div class="sheet-title">Sheet Viewer (Live)</div>
      <div class="sheet-actions">
        <button onclick="addRow()">Add Row</button>
        <button onclick="saveGrid()">Save Grid</button>
        <button onclick="closeSheetModal()">Close</button>
      </div>
    </div>
    <div class="sheet-body">
      <table id="sheetTable" class="sheet"></table>
    </div>
  </div>
</div>

<!-- Undo snackbar -->
<div id="undoBar">
  <div class="content">
    <span>Order completed</span>
    <button onclick="undoRemove()">Undo</button>
  </div>
  <div id="undoProgress"></div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = "REPLACE_WITH_YOUR_DEPLOYED_APPS_SCRIPT_WEB_APP_URL";
const prices = { burger:7, hotdog:5, soda:1 };

/* ===== UTIL ===== */
function showOverlay(on=true){
  document.getElementById('overlay').style.display = on ? 'flex' : 'none';
}
function todayStr(d=new Date()){
  const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function fmtTimer(ms){
  const s=Math.floor(ms/1000), m=Math.floor(s/60), sec=s%60;
  return `${m}:${String(sec).padStart(2,'0')}`;
}
function timerClass(ms){
  const s=ms/1000; if(s<60) return 'green'; if(s<180) return 'orange'; return 'red';
}

/* ===== STATE ===== */
let qty = { burger:0, hotdog:0, soda:0 };
let compOrder=false;
let selectedPayment=null;
let allSales=[];
let orders=[];           // {id,rowId,ts,dateStr,burger,hotdog,soda,total,comp}
let removed = null;      // {ticket, index, startedAt, timer}
let undoTimer=null;      // snackbar timer
let timerInterval=null;  // orders timer loop

/* ===== MAIN (POS) ===== */
window.addEventListener('load', ()=>{
  const od=document.getElementById('orderDate'); if(od) od.value=todayStr();
  renderPOS();
});

function changeQty(item,delta){ qty[item]=Math.max(0, qty[item]+delta); renderPOS(); }
function toggleComp(){ compOrder=!compOrder; renderPOS(); }
function selectPayment(type){
  if(selectedPayment===type){ selectedPayment=null; document.getElementById('cashBtn').classList.remove('selected'); document.getElementById('cardBtn').classList.remove('selected'); }
  else { selectedPayment=type; document.getElementById('cashBtn').classList.toggle('selected', type==='cash'); document.getElementById('cardBtn').classList.toggle('selected', type==='card'); }
}
function renderPOS(){
  document.getElementById('burgerQty').textContent=qty.burger;
  document.getElementById('hotdogQty').textContent=qty.hotdog;
  document.getElementById('sodaQty').textContent=qty.soda;
  let total = qty.burger*prices.burger + qty.hotdog*prices.hotdog + qty.soda*prices.soda;
  if(compOrder) total=0;
  document.getElementById('total').textContent=total;
  document.getElementById('total').className = compOrder ? 'highlight' : '';
  document.getElementById('compHint').textContent = compOrder ? 'Comp active: total is $0 (items still counted as sold)' : '';
}

async function submitOrder(){
  if(qty.burger===0 && qty.hotdog===0 && qty.soda===0){ alert('No items selected'); return; }
  if(!selectedPayment){ alert('Select a payment method'); return; }
  const btn=document.getElementById('submitBtn');
  btn.textContent='Loading…'; btn.disabled=true; showOverlay(true);

  const dateStr = document.getElementById('orderDate').value || todayStr();
  const total = compOrder ? 0 : (qty.burger*prices.burger + qty.hotdog*prices.hotdog + qty.soda*prices.soda);
  const payment = compOrder ? 'N/A' : selectedPayment;

  try{
    const res = await fetch(API_URL, {
      method:'POST',
      body: JSON.stringify({
        mode:'create',
        Date: dateStr,
        Burger: qty.burger,
        Hotdog: qty.hotdog,
        Soda: qty.soda,
        'Payment Method': payment,
        Total: total,
        Time: '' // filled when completed
      })
    });
    const data = await res.json();
    const rowId = data && data.rowId ? data.rowId : null;

    // create ticket
    const ticket = {
      id:`t_${Date.now()}_${Math.random().toString(36).slice(2,7)}`,
      rowId,
      ts:Date.now(),
      dateStr,
      burger:qty.burger, hotdog:qty.hotdog, soda:qty.soda,
      total, comp:compOrder
    };
    orders.push(ticket);
    // reset POS
    qty={burger:0, hotdog:0, soda:0}; compOrder=false; selectedPayment=null;
    document.getElementById('cashBtn').classList.remove('selected');
    document.getElementById('cardBtn').classList.remove('selected');
    renderPOS();
    alert('Order submitted');
  }catch(e){
    alert('Error submitting order.');
  }finally{
    btn.textContent='Submit Order'; btn.disabled=false; showOverlay(false);
  }
}

/* ===== ORDERS ===== */
function showOrders(){
  document.getElementById('main-screen').style.display='none';
  document.getElementById('admin-screen').style.display='none';
  document.getElementById('orders-screen').style.display='block';
  renderOrders();
}
function showMain(){
  document.getElementById('orders-screen').style.display='none';
  document.getElementById('admin-screen').style.display='none';
  document.getElementById('main-screen').style.display='block';
}
function renderOrders(){
  const grid=document.getElementById('orders-grid');
  const empty=document.getElementById('orders-empty');
  grid.innerHTML='';
  if(!orders.length){ empty.style.display='block'; }
  else{
    empty.style.display='none';
    for(const t of orders){
      const card=document.createElement('div'); card.className='ticket'; card.dataset.id=t.id;

      const head=document.createElement('div'); head.className='ticket-head';
      const dl=document.createElement('div');
      const [y,m,d]=t.dateStr.split('-'); dl.textContent=`${parseInt(m)}/${parseInt(d)}/${y}`;
      const tm=document.createElement('div'); tm.className='timer'; tm.dataset.ts=t.ts; tm.textContent='0:00';
      head.appendChild(dl); head.appendChild(tm);

      const items=document.createElement('div'); items.className='ticket-items';
      const lines=[]; if(t.burger>0) lines.push(`${t.burger} Burgers`);
      if(t.hotdog>0) lines.push(`${t.hotdog} Hot Dogs`);
      if(t.soda>0)   lines.push(`${t.soda} Sodas`);
      items.textContent=lines.join('\n');

      const footer=document.createElement('div'); footer.className='ticket-footer';
      const tot=document.createElement('div'); tot.innerHTML=`Total: $<strong>${t.total}</strong>${t.comp?' <span class="highlight">(COMP)</span>':''}`;
      const done=document.createElement('button'); done.className='done-btn'; done.textContent='✓ Done';
      done.onclick=()=>removeTicket(t.id);
      footer.appendChild(tot); footer.appendChild(done);

      card.appendChild(head); card.appendChild(items); card.appendChild(footer);
      grid.appendChild(card);
    }
  }
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(updateAllTimers,1000);
  updateAllTimers();
}
function updateAllTimers(){
  const now=Date.now();
  document.querySelectorAll('.ticket .timer').forEach(el=>{
    const ts=Number(el.dataset.ts), ms=now-ts;
    el.textContent = fmtTimer(ms);
    el.classList.remove('green','orange','red');
    el.classList.add(timerClass(ms));
  });
}

/* Complete ticket with 5s undo; write Time only after undo window */
function removeTicket(id){
  const idx=orders.findIndex(o=>o.id===id);
  if(idx===-1) return;
  const ticket=orders[idx];
  orders.splice(idx,1);
  renderOrders();

  removed = { ticket, index: idx, startedAt: Date.now(), timer: null };
  // show undo bar
  const bar=document.getElementById('undoBar'), prog=document.getElementById('undoProgress');
  prog.style.transition='none'; prog.style.width='100%'; void prog.offsetWidth;
  prog.style.transition='width 5s linear'; prog.style.width='0%';
  bar.style.display='block';

  if(undoTimer) clearTimeout(undoTimer);
  undoTimer=setTimeout(async ()=>{
    // commit Time to sheet (only if we still have removed)
    if(removed && removed.ticket && removed.ticket.rowId){
      const elapsedMs = Date.now() - removed.ticket.ts;
      const timeStr = fmtTimer(elapsedMs);
      try{
        await fetch(`${API_URL}?rowId=${encodeURIComponent(removed.ticket.rowId)}`, {
          method:'PUT',
          body: JSON.stringify({ Time: timeStr })
        });
      }catch(e){ /* silent; prevent UI block */ }
    }
    document.getElementById('undoBar').style.display='none';
    removed=null;
  },5000);
}
function undoRemove(){
  if(!removed) return;
  // restore ticket
  const {ticket,index}=removed;
  orders.splice(Math.min(index,orders.length),0,ticket);
  removed=null;
  renderOrders();
  if(undoTimer) clearTimeout(undoTimer);
  document.getElementById('undoBar').style.display='none';
}

/* ===== ADMIN ===== */
async function showAdmin(){
  document.getElementById('main-screen').style.display='none';
  document.getElementById('orders-screen').style.display='none';
  document.getElementById('admin-screen').style.display='block';

  const loading=document.getElementById('admin-loading');
  const select=document.getElementById('dateSelect');
  showOverlay(true);
  loading.style.display='block';
  try{
    const res=await fetch(`${API_URL}?mode=list`,{cache:'no-store'});
    allSales = await res.json();
    const dates = [...new Set(allSales.map(r=>r.Date))].filter(Boolean);
    select.innerHTML='';
    if(dates.length===0){
      document.getElementById('totalBlock').innerHTML = "<strong>Total</strong><br>No data available yet.";
      setAdminCardsEmpty();
    }else{
      for(const d of dates){
        const opt=document.createElement('option'); opt.value=d;
        const [y,m,day]=d.split('-'); opt.textContent=`${parseInt(m)}/${parseInt(day)}/${y}`;
        select.appendChild(opt);
      }
      loadStats();
    }
  }catch(e){
    alert('Error loading admin data.');
  }finally{
    loading.style.display='none';
    showOverlay(false);
  }
}
function setAdminCardsEmpty(){
  document.getElementById('hdMoney').textContent = 'Money: $0';
  document.getElementById('hdItems').textContent = 'Items: 0';
  document.getElementById('bgMoney').textContent = 'Money: $0';
  document.getElementById('bgItems').textContent = 'Items: 0';
  document.getElementById('sdMoney').textContent = 'Money: $0';
  document.getElementById('sdItems').textContent = 'Items: 0';
  document.getElementById('cashMoney').textContent = 'Money: $0';
  document.getElementById('cashItems').textContent = '';
  document.getElementById('cardMoney').textContent = 'Money: $0';
  document.getElementById('cardItems').textContent = '';
}
function loadStats(){
  const date=document.getElementById('dateSelect').value;
  const data=allSales.filter(r=>r.Date===date);
  if(data.length===0){
    document.getElementById('totalBlock').innerHTML="<strong>Total</strong><br>No data for selected date.";
    setAdminCardsEmpty(); return;
  }
  const s={total:0, burgerMoney:0, hotdogMoney:0, sodaMoney:0, burgerItems:0, hotdogItems:0, sodaItems:0, cash:0, card:0};
  for(const o of data){
    const isComp = (String(o['Payment Method']).toLowerCase()==='n/a');
    const b=Number(o.Burger)||0, h=Number(o.Hotdog)||0, sd=Number(o.Soda)||0;
    const subtotal = isComp ? 0 : b*prices.burger + h*prices.hotdog + sd*prices.soda;
    s.total+=subtotal;
    s.burgerMoney+= isComp?0:b*prices.burger; s.burgerItems+=b;
    s.hotdogMoney+= isComp?0:h*prices.hotdog; s.hotdogItems+=h;
    s.sodaMoney  += isComp?0:sd*prices.soda;  s.sodaItems  +=sd;
    if(!isComp){
      if(o['Payment Method']==='cash') s.cash+=subtotal;
      if(o['Payment Method']==='card') s.card+=subtotal;
    }
  }
  document.getElementById('totalBlock').innerHTML = `<strong>Total</strong><br>Money: $${s.total}`;
  document.getElementById('bgMoney').textContent = `Money: $${s.burgerMoney}`;
  document.getElementById('bgItems').textContent = `Items: ${s.burgerItems}`;
  document.getElementById('hdMoney').textContent = `Money: $${s.hotdogMoney}`;
  document.getElementById('hdItems').textContent = `Items: ${s.hotdogItems}`;
  document.getElementById('sdMoney').textContent = `Money: $${s.sodaMoney}`;
  document.getElementById('sdItems').textContent = `Items: ${s.sodaItems}`;
  document.getElementById('cashMoney').textContent = `Money: $${s.cash}`;
  document.getElementById('cardMoney').textContent = `Money: $${s.card}`;
}

/* ===== Sheet Modal (Editable Grid) ===== */
function openSheetModal(){ document.getElementById('sheet-modal').style.display='flex'; loadSheetIntoGrid(); }
function closeSheetModal(){ document.getElementById('sheet-modal').style.display='none'; }
async function loadSheetIntoGrid(){
  showOverlay(true);
  const tbl=document.getElementById('sheetTable'); tbl.innerHTML='';
  try{
    const res = await fetch(`${API_URL}?mode=sheet`, {cache:'no-store'});
    const data = await res.json(); // 2D array including header
    if(!Array.isArray(data) || data.length===0){ tbl.innerHTML='<tr><td>No data</td></tr>'; return; }
    // header
    const thead = document.createElement('thead');
    const htr = document.createElement('tr');
    const headers = data[0];
    headers.forEach(h=>{
      const th=document.createElement('th'); th.textContent=h || '';
      htr.appendChild(th);
    });
    const thCtrl=document.createElement('th'); thCtrl.textContent='Actions'; htr.appendChild(thCtrl);
    thead.appendChild(htr); tbl.appendChild(thead);
    // body
    const tbody=document.createElement('tbody');
    for(let r=1;r<data.length;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<headers.length;c++){
        const td=document.createElement('td');
        td.contentEditable = true;
        td.textContent = (data[r][c]!==undefined? data[r][c] : '');
        tr.appendChild(td);
      }
      const ctrl=document.createElement('td');
      ctrl.className='row-controls';
      const del=document.createElement('button'); del.textContent='Delete'; del.onclick=()=>{ tr.remove(); };
      ctrl.appendChild(del);
      tr.appendChild(ctrl);
      tbody.appendChild(tr);
    }
    // add an empty row if only header exists
    if(data.length===1){
      const tr=document.createElement('tr');
      headers.forEach(()=>{ const td=document.createElement('td'); td.contentEditable=true; tr.appendChild(td); });
      const ctrl=document.createElement('td'); ctrl.className='row-controls';
      const del=document.createElement('button'); del.textContent='Delete'; del.onclick=()=>{ tr.remove(); };
      ctrl.appendChild(del); tr.appendChild(ctrl); tbody.appendChild(tr);
    }
    tbl.appendChild(tbody);
  }catch(e){
    alert('Failed to load sheet.');
  }finally{
    showOverlay(false);
  }
}
function addRow(){
  const tbl=document.getElementById('sheetTable');
  const headers = Array.from(tbl.querySelectorAll('thead th')).map(th=>th.textContent);
  const tr=document.createElement('tr');
  for(let c=0;c<headers.length-1;c++){ // exclude Actions
    const td=document.createElement('td'); td.contentEditable=true; tr.appendChild(td);
  }
  const ctrl=document.createElement('td'); ctrl.className='row-controls';
  const del=document.createElement('button'); del.textContent='Delete'; del.onclick=()=>{ tr.remove(); };
  ctrl.appendChild(del); tr.appendChild(ctrl);
  tbl.querySelector('tbody').appendChild(tr);
}
async function saveGrid(){
  const tbl=document.getElementById('sheetTable');
  const headers = Array.from(tbl.querySelectorAll('thead th')).map(th=>th.textContent);
  const bodyRows = Array.from(tbl.querySelectorAll('tbody tr')).map(tr=>{
    return Array.from(tr.querySelectorAll('td')).slice(0, headers.length-1).map(td=>td.textContent.trim());
  });
  // Push entire sheet back (header + body)
  const values = [headers.slice(0, headers.length-1), ...bodyRows]; // exclude 'Actions' header/col
  showOverlay(true);
  try{
    await fetch(`${API_URL}?mode=replace`, { method:'PUT', body: JSON.stringify({ values }) });
    alert('Sheet saved.');
  }catch(e){
    alert('Failed to save sheet.');
  }finally{
    showOverlay(false);
  }
}
</script>
</body>
</html>

